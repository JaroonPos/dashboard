<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
  <form id="saleForm">
    <label>Orders: <input type="number" id="orders" required></label><br>
    <label>Sales: <input type="number" id="sales" required></label><br>
    <label>Units: <input type="number" id="units" required></label><br>
    <label>Password: <input type="password" id="password" required></label><br>
    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </form>

  <script>
    const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co'; // üîπ ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jbXNraHJ5cHhlbGpnbmN5ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDcyMzIsImV4cCI6MjA3MzQ4MzIzMn0.clWbGRV1MrUHnWPyTEc66fnjbD8mLqo6fF1V6qiOJa4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ‡∏î‡∏∂‡∏á user_id ‡∏à‡∏≤‡∏Å query string
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("user_id");

    document.getElementById("saleForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const orders = parseInt(document.getElementById("orders").value);
      const sales = parseFloat(document.getElementById("sales").value);
      const units = parseInt(document.getElementById("units").value);
      const password = document.getElementById("password").value;

      // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö password ‡∏Ç‡∏≠‡∏á user ‡∏Å‡πà‡∏≠‡∏ô
      const { data: users, error: userError } = await supabase
        .from("userDash")
        .select("id, password")
        .eq("id", userId)
        .single();

      if (userError || !users) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        return;
      }

      if (users.password !== password) {
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }

      // 2. Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      const { error: insertError } = await supabase
        .from("sales")
        .insert([{
          user_id: userId,
          orders,
          sales,
          units
        }]);

      if (insertError) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + insertError.message);
      } else {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
