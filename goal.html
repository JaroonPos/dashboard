<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Settings)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="max-w-xl w-full bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
      üéØ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
    </h1>

    <form id="goalForm" class="space-y-6">

      <div>
        <label for="userSelect" classD="block text-sm font-medium text-gray-700 mb-2">
          ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Salesperson)
        </label>
        <select id="userSelect" name="user_id" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</option>
          </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Type)</label>
        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-100 rounded-lg">
          <label>
            <input type="radio" name="goalType" value="daily" class="sr-only peer" checked>
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </span>
          </label>
          <label>
            <input type="radio" name="goalType" value="monthly" class="sr-only peer">
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </span>
          </label>
        </div>
      </div>

      <div>
        <div id="dailyGoalArea">
          <label for="goalDate" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)
          </label>
          <input type="date" id="goalDate" name="date" required
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>

        <div id="monthlyGoalArea" class="hidden">
          <label for="goalMonth" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)
          </label>
          <select id="goalMonth" name="month"
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
          </select>
          <p class="text-xs text-gray-500 mt-2">
            *‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ) ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á DB
          </p>
        </div>
      </div>

      <div>
        <h3 class="text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Targets)</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="targetSales" class="block text-xs text-gray-600 mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label>
            <input type="number" id="targetSales" name="target_sales" placeholder="0" required
              class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          </div>
          <div>
            <label for="targetOrders" class="block text-xs text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</slabel>
            <input type="number" id="targetOrders" name="target_orders" placeholder="0" required
              class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          </div>
          <div>
            <label for="targetUnits" class="block text-xs text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</label>
            <input type="number" id="targetUnits" name="target_units" placeholder="0" required
              class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          </div>
        </div>
      </div>

      <button type="submit" id="saveGoalBtn"
        class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-8 font-semibold flex items-center justify-center gap-2
               disabled:bg-gray-400">
        <span>‚úÖ</span>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
      </button>
      
      <div id="formMessage" class="text-center mt-4"></div>

    </form>
  </div>


  <script>
    // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE ---
    // ‚ö†Ô∏è (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jbXNraHJ5cHhlbGpnbmN5ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDcyMzIsImV4cCI6MjA3MzQ4MzIzMn0.clWbGRV1MrUHnWPyTEc66fnjbD8mLqo6fF1V6qiOJa4';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM ---
    const goalForm = document.getElementById('goalForm');
    const userSelect = document.getElementById('userSelect');
    const goalTypeRadios = document.querySelectorAll('input[name="goalType"]');
    const dailyArea = document.getElementById('dailyGoalArea');
    const monthlyArea = document.getElementById('monthlyGoalArea');
    const goalDate = document.getElementById('goalDate');
    const goalMonth = document.getElementById('goalMonth');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    const formMessage = document.getElementById('formMessage');

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (userDash) ---
    async function loadUsers() {
      const { data, error } = await supabase
        .from('userDash') // ‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á user ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        .select('id, userName');

      if (error) {
        console.error('Error loading users:', error.message);
        userSelect.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option>';
        return;
      }

      if (data.length > 0) {
        userSelect.innerHTML = '<option value="" disabled selected>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</option>';
        data.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id; // ‡∏™‡πà‡∏á user.id ‡πÑ‡∏õ‡∏¢‡∏±‡∏á DB
          option.textContent = user.userName;
          userSelect.appendChild(option);
        });
      } else {
        userSelect.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</option>';
      }
    }

    // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Daily/Monthly ---
    function toggleGoalArea() {
      const selectedValue = document.querySelector('input[name="goalType"]:checked').value;

      if (selectedValue === 'daily') {
        dailyArea.classList.remove('hidden');
        monthlyArea.classList.add('hidden');
        goalDate.setAttribute('required', 'true'); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 'date' ‡πÄ‡∏õ‡πá‡∏ô required
        goalMonth.removeAttribute('required');      // ‡∏•‡∏ö 'month' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å required
      } else {
        dailyArea.classList.add('hidden');
        monthlyArea.classList.remove('hidden');
        goalDate.removeAttribute('required');       // ‡∏•‡∏ö 'date' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å required
        goalMonth.setAttribute('required', 'true'); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 'month' ‡πÄ‡∏õ‡πá‡∏ô required
      }
    }

    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (Submit) ---
    async function handleFormSubmit(event) {
      event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
      saveGoalBtn.disabled = true;
      saveGoalBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      formMessage.textContent = '';

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
      const formData = new FormData(goalForm);
      const type = formData.get('goalType');

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Supabase ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB
      const goalObject = {
        user_id: formData.get('user_id'),
        type: type,
        target_sales: parseInt(formData.get('target_sales')) || 0,
        target_orders: parseInt(formData.get('target_orders')) || 0,
        target_units: parseInt(formData.get('target_units')) || 0,
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡πà‡∏á date ‡∏´‡∏£‡∏∑‡∏≠ month ‡∏ï‡∏≤‡∏° type ---
        date: type === 'daily' ? formData.get('date') : null,
        month: type === 'monthly' ? parseInt(formData.get('month')) : null
      };

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'goals'
      const { data, error } = await supabase
        .from('goals') // ‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á goals ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        .insert([goalObject])
        .select();

      if (error) {
        console.error('Error saving goal:', error.message);
        formMessage.innerHTML = `<span class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`;
        saveGoalBtn.disabled = false;
        saveGoalBtn.innerHTML = '<span>‚úÖ</span> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>';
      } else {
        console.log('Goal saved successfully:', data);
        formMessage.innerHTML = '<span class="text-green-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>';
        goalForm.reset(); // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        toggleGoalArea(); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
        
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
        setTimeout(() => {
          formMessage.textContent = '';
          saveGoalBtn.disabled = false;
          saveGoalBtn.innerHTML = '<span>‚úÖ</span> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>';
        }, 3000);
      }
    }

    // --- 6. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°
      toggleGoalArea(); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Daily/Monthly
      goalTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleGoalArea);
      });

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Submit
      goalForm.addEventListener('submit', handleFormSubmit);
    });
  </script>

</body>
</html>