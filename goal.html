<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sales Goal)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="max-w-xl w-full bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
    <!-- üîπ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Dashboard -->
    <div class="flex justify-start mb-4">
      <a href="index.html"
        class="inline-flex items-center gap-2 text-blue-600 border border-blue-200 bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100 hover:text-blue-700 transition-all duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Dashboard
      </a>
    </div>
    
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
      üéØ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
    </h1>

    <form id="goalForm" class="space-y-6">

      <div>
        <label for="userCheckboxList" class="block text-sm font-medium text-gray-700 mb-2">
          ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Salespeople)
        </label>
        <div id="userCheckboxList" class="grid grid-cols-2 gap-2 bg-gray-50 border border-gray-200 p-3 rounded-lg">
          <p class="text-gray-500 text-sm col-span-2" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</p>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Type)</label>
        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-100 rounded-lg">
          <label>
            <input type="radio" name="goalType" value="daily" class="sr-only peer" checked>
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </span>
          </label>
          <label>
            <input type="radio" name="goalType" value="monthly" class="sr-only peer">
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </span>
          </label>
        </div>
      </div>

      <div>
        <div id="dailyGoalArea">
          <label for="goalDate" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)
          </label>
          <input type="date" id="goalDate" name="date" required
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>

        <div id="monthlyGoalArea" class="hidden">
          <label for="goalMonth" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)
          </label>
          <select id="goalMonth" name="month"
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
          </select>
        </div>
      </div>

      <div>
        <label for="targetSales" class="block text-sm font-medium text-gray-700 mb-2">
          ‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)
        </label>
        <input type="number" id="targetSales" name="target_sales" placeholder="0" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <div>
        <label for="goalPassword" class="block text-sm font-medium text-gray-700 mb-2">
          ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)
        </label>
        <input type="password" id="goalPassword" name="goalPassword" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
          required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>


      <button type="submit" id="saveGoalBtn"
        class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-8 font-semibold flex items-center justify-center gap-2
               disabled:bg-gray-400">
        <span>‚úÖ</span>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
      </button>
      
      <div id="formMessage" class="text-center mt-4"></div>
      
      <div id="goalDataDisplay" class="hidden bg-green-50 border border-green-300 text-green-800 p-4 rounded-lg mt-4 text-sm space-y-1">
        <h4 class="font-bold text-base">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:</h4>
        <p><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</strong> <span id="displayUser"></span></p>
        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span id="displayType"></span></p>
        <p><strong>‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</strong> <span id="displaySales"></span></p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> <span id="displayPeriod"></span></p>
        <p class="text-xs text-gray-500 mt-2">ID ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: <span id="displayID"></span></p>
      </div>
      
    </form>
  </div>


  <script>
  // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE ---
  const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co'; 
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jbXNraHJ5cHhlbGpnbmN5ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDcyMzIsImV4cCI6MjA3MzQ4MzIzMn0.clWbGRV1MrUHnWPyTEc66fnjbD8mLqo6fF1V6qiOJa4';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // üîí ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ)
  const GOAL_SAVE_PASSWORD = "P@ssw0rd@2025";

  // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DOM ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  const goalForm = document.getElementById('goalForm');
  const goalTypeRadios = document.querySelectorAll('input[name="goalType"]');
  const dailyArea = document.getElementById('dailyGoalArea');
  const monthlyArea = document.getElementById('monthlyGoalArea');
  const goalDateInput = document.getElementById('goalDate'); 
  const goalMonthSelect = document.getElementById('goalMonth');

  const saveGoalBtn = document.getElementById('saveGoalBtn');
  const formMessage = document.getElementById('formMessage');
  const goalDataDisplay = document.getElementById('goalDataDisplay');
  const displayUser = document.getElementById('displayUser');
  const displayType = document.getElementById('displayType');
  const displaySales = document.getElementById('displaySales');
  const displayPeriod = document.getElementById('displayPeriod');
  const displayID = document.getElementById('displayID');


  // --- 2. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ user ---
  async function loadUsers() {
    const container = document.getElementById('userCheckboxList');
    const loadingText = document.getElementById('loadingText');

    const { data, error } = await supabase
      .from('userDash')
      .select('id, userName')
      .eq('statusUser', 1)
      .order('userName', { ascending: true });

    if (error) {
      console.error('Error loading users:', error.message);
      loadingText.textContent = '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      return;
    }

    container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."
    data.forEach(user => {
      const wrapper = document.createElement('label');
      wrapper.className = 'flex items-center space-x-2 bg-white border border-gray-200 p-2 rounded hover:bg-blue-50 cursor-pointer';
      wrapper.innerHTML = `
        <input type="checkbox" value="${user.id}" class="user-checkbox accent-blue-600">
        <span>${user.userName}</span>
      `;
      container.appendChild(wrapper);
    });
  }


  // --- 3. ‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
  function toggleGoalArea() {
    const selected = document.querySelector('input[name="goalType"]:checked').value;

    if (selected === 'daily') {
      // 1. ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
      dailyArea.classList.remove('hidden');
      monthlyArea.classList.add('hidden');
      
      // 2. ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ required (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
      goalDateInput.required = true;
      goalMonthSelect.required = false; 
      
    } else { // 'monthly'
      // 1. ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
      dailyArea.classList.add('hidden');
      monthlyArea.classList.remove('hidden');
      
      // 2. ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ required (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
      goalDateInput.required = false; // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ Error ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      goalMonthSelect.required = true;
    }
  }

  // --- 4. Submit form (Insert Goal) ---
  async function handleFormSubmit(event) {
    event.preventDefault();

    const passwordInput = document.getElementById("goalPassword").value.trim();
    if (passwordInput !== GOAL_SAVE_PASSWORD) {
      formMessage.innerHTML = `<span class="text-red-500 font-semibold">‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>`;
      return;
    }

    saveGoalBtn.disabled = true;
    saveGoalBtn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    const formData = new FormData(goalForm);
    const type = formData.get('goalType');
    const targetSales = parseInt(formData.get('target_sales')) || 0;
    const date = type === 'daily' ? formData.get('date') : null;

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á month ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    let month = null;
    if (type === 'monthly') {
      const monthVal = formData.get('month');
      month = monthVal ? parseInt(monthVal) : null;
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkedBoxes.length === 0) {
      formMessage.innerHTML = `<span class="text-red-500">‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô</span>`;
      saveGoalBtn.disabled = false;
      saveGoalBtn.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢";
      return;
    }

    const records = Array.from(checkedBoxes).map(cb => ({
      user_id: parseInt(cb.value),
      type,
      target_sales: targetSales,
      date,
      month
    }));

    console.log("üéØ Insert Data Preview:", records);

    const { data, error } = await supabase
      .from('goals')
      .insert(records)
      .select(`
        id, user_id, type, target_sales, date, month,
        userDash (userName)
      `);

    if (error) {
      console.error('Error saving multiple goals:', error.message);
      formMessage.innerHTML = `<span class="text-red-500">‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}</span>`;
    } else {
      const monthNames = ["", "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      formMessage.innerHTML = `<span class="text-green-600">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>`;
      goalDataDisplay.classList.remove('hidden');
      displayUser.textContent = data.map(d => d.userDash?.userName).join(', ');
      displayType.textContent = type === 'daily' ? '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      displaySales.textContent = "‡∏ø" + targetSales.toLocaleString();
      displayPeriod.textContent = type === 'daily' ? date : monthNames[month] || '-';
      displayID.textContent = data.map(d => d.id).join(', ');
      goalForm.reset();
      toggleGoalArea();
    }

    saveGoalBtn.disabled = false;
    saveGoalBtn.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢";
  }



  // --- Event Listeners ---
  document.addEventListener("DOMContentLoaded", () => {
    loadUsers();
    toggleGoalArea();
    goalTypeRadios.forEach(radio => radio.addEventListener("change", toggleGoalArea));
    goalForm.addEventListener("submit", handleFormSubmit);
  });
</script>


</body>
</html>