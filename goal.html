<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale-1.0">
  <title>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sales Goal)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="max-w-xl w-full bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
      üéØ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
    </h1>

    <form id="goalForm" class="space-y-6">

      <div>
        <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-2">
          ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Salesperson)
        </label>
        <select id="userSelect" name="user_id" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Type)</label>
        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-100 rounded-lg">
          <label>
            <input type="radio" name="goalType" value="daily" class="sr-only peer" checked>
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </span>
          </label>
          <label>
            <input type="radio" name="goalType" value="monthly" class="sr-only peer">
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </span>
          </label>
        </div>
      </div>

      <div>
        <div id="dailyGoalArea">
          <label for="goalDate" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)
          </label>
          <input type="date" id="goalDate" name="date" required
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>

        <div id="monthlyGoalArea" class="hidden">
          <label for="goalMonth" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)
          </label>
          <select id="goalMonth" name="month"
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
          </select>
        </div>
      </div>

      <div>
        <label for="targetSales" class="block text-sm font-medium text-gray-700 mb-2">
          ‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)
        </label>
        <input type="number" id="targetSales" name="target_sales" placeholder="0" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <button type="submit" id="saveGoalBtn"
        class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-8 font-semibold flex items-center justify-center gap-2
               disabled:bg-gray-400">
        <span>‚úÖ</span>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
      </button>
      
      <div id="formMessage" class="text-center mt-4"></div>

      <div id="goalDataDisplay" class="hidden bg-green-50 border border-green-300 text-green-800 p-4 rounded-lg mt-4 text-sm space-y-1">
        <h4 class="font-bold text-base">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:</h4>
        <p><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</strong> <span id="displayUser"></span></p>
        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span id="displayType"></span></p>
        <p><strong>‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</strong> <span id="displaySales"></span></p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> <span id="displayPeriod"></span></p>
        <p class="text-xs text-gray-500 mt-2">ID ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: <span id="displayID"></span></p>
      </div>

    </form>
  </div>


  <script>
    // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE ---
    const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jbXNraHJ5cHhlbGpnbmN5ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDcyMzIsImV4cCI6MjA3MzQ4MzIzMn0.clWbGRV1MrUHnWPyTEc66fnjbD8mLqo6fF1V6qiOJa4';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ... (‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)

    // --- 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà) ---
    const goalForm = document.getElementById('goalForm');
    // ... (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)
    const formMessage = document.getElementById('formMessage');

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà
    const goalDataDisplay = document.getElementById('goalDataDisplay');
    const displayUser = document.getElementById('displayUser');
    const displayType = document.getElementById('displayType');
    const displaySales = document.getElementById('displaySales');
    const displayPeriod = document.getElementById('displayPeriod');
    const displayID = document.getElementById('displayID');
    // ...

    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (Submit) (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà) ---
    async function handleFormSubmit(event) {
    event.preventDefault(); 
    
    // ‡∏õ‡∏¥‡∏î/‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    goalDataDisplay.classList.add('hidden'); 
    formMessage.textContent = ''; 
    
    saveGoalBtn.disabled = true;
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° icon ‡∏´‡∏°‡∏∏‡∏ô‡πÜ
    saveGoalBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 -ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';


    const formData = new FormData(goalForm);
    const type = formData.get('goalType');
    const monthName = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

    const goalObject = {
        user_id: formData.get('user_id'),
        type: type,
        target_sales: parseInt(formData.get('target_sales')) || 0,
        date: type === 'daily' ? formData.get('date') : null,
        month: type === 'monthly' ? parseInt(formData.get('month')) : null
    };
    
    // ‚úÖ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug) ‡πÅ‡∏™‡∏î‡∏á Object ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Supabase ‡πÉ‡∏ô Console
    console.log('Data to be inserted:', goalObject);

    // ‚úÖ 1. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'goals' ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ .select() 
    //    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Supabase ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á ID ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠ User)
    const { data, error } = await supabase
        .from('goals') 
        .insert([goalObject])
        .select(`
            *,
            userDash(userName)  
        `);

    if (error) {
        console.error('Error saving goal:', error.message);
        formMessage.innerHTML = `<span class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`;
    } else {
        // ‚úÖ 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô data[0]
        const savedData = data[0];
        const targetUser = savedData.userDash?.userName || 'N/A';
        
        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const periodDisplay = savedData.type === 'daily' 
                            ? savedData.date 
                            : monthName[savedData.month - 1]; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

        formMessage.innerHTML = '<span class="text-green-500">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>';
        
        // ‚úÖ 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà
        displayUser.textContent = targetUser;
        displayType.textContent = savedData.type === 'daily' ? '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
        displaySales.textContent = '‡∏ø' + savedData.target_sales.toLocaleString();
        displayPeriod.textContent = periodDisplay;
        displayID.textContent = savedData.id;
        goalDataDisplay.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        
        goalForm.reset(); // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        toggleGoalArea(); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
    }
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
    saveGoalBtn.disabled = false;
    saveGoalBtn.innerHTML = '<span>‚úÖ</span> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>';
    }

    // --- 6. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();        
      toggleGoalArea(); 

      goalTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleGoalArea);
      });

      goalForm.addEventListener('submit', handleFormSubmit);
    });
  </script>

</body>
</html>