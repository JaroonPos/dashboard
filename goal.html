<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sales Goal)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="max-w-xl w-full bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
      üéØ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
    </h1>

    <form id="goalForm" class="space-y-6">

      <div>
        <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-2">
          ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Salesperson)
        </label>
        <select id="userSelect" name="user_id" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Type)</label>
        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-100 rounded-lg">
          <label>
            <input type="radio" name="goalType" value="daily" class="sr-only peer" checked>
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </span>
          </label>
          <label>
            <input type="radio" name="goalType" value="monthly" class="sr-only peer">
            <span class="w-full block text-center p-2 rounded-md text-gray-600 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow font-medium cursor-pointer transition-all">
              ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </span>
          </label>
        </div>
      </div>

      <div>
        <div id="dailyGoalArea">
          <label for="goalDate" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)
          </label>
          <input type="date" id="goalDate" name="date" required
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>

        <div id="monthlyGoalArea" class="hidden">
          <label for="goalMonth" class="block text-sm font-medium text-gray-700 mb-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)
          </label>
          <select id="goalMonth" name="month"
            class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
          </select>
        </div>
      </div>

      <div>
        <label for="targetSales" class="block text-sm font-medium text-gray-700 mb-2">
          ‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)
        </label>
        <input type="number" id="targetSales" name="target_sales" placeholder="0" required
          class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <button type="submit" id="saveGoalBtn"
        class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-8 font-semibold flex items-center justify-center gap-2
               disabled:bg-gray-400">
        <span>‚úÖ</span>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
      </button>
      
      <div id="formMessage" class="text-center mt-4"></div>
      
      <div id="goalDataDisplay" class="hidden bg-green-50 border border-green-300 text-green-800 p-4 rounded-lg mt-4 text-sm space-y-1">
        <h4 class="font-bold text-base">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:</h4>
        <p><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</strong> <span id="displayUser"></span></p>
        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span id="displayType"></span></p>
        <p><strong>‡πÄ‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</strong> <span id="displaySales"></span></p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> <span id="displayPeriod"></span></p>
        <p class="text-xs text-gray-500 mt-2">ID ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: <span id="displayID"></span></p>
      </div>
      
    </form>
  </div>


  <script>
  // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE ---
  const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5c...<‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢>';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DOM ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  const goalForm = document.getElementById('goalForm');
  const userSelect = document.getElementById('userSelect');
  const goalTypeRadios = document.querySelectorAll('input[name="goalType"]');
  const dailyArea = document.getElementById('goalDate').parentElement;
  const monthlyArea = document.getElementById('monthlyGoalArea');
  const saveGoalBtn = document.getElementById('saveGoalBtn');

  const formMessage = document.getElementById('formMessage');
  const goalDataDisplay = document.getElementById('goalDataDisplay');
  const displayUser = document.getElementById('displayUser');
  const displayType = document.getElementById('displayType');
  const displaySales = document.getElementById('displaySales');
  const displayPeriod = document.getElementById('displayPeriod');
  const displayID = document.getElementById('displayID');

  // --- 2. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ user ---
  async function loadUsers() {
    const { data, error } = await supabase
      .from('userDash')
      .select('id, userName')
      .eq("statusUser", 1); // ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ active user

    if (error) {
      console.error('Error loading users:', error);
      userSelect.innerHTML = '<option value="" disabled>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
      return;
    }

    userSelect.innerHTML = '<option value="" disabled selected>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</option>';

    data.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.userName;
      userSelect.appendChild(option);
    });
  }

  // --- 3. ‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
  function toggleGoalArea() {
    const selected = document.querySelector('input[name="goalType"]:checked').value;

    if (selected === 'daily') {
      dailyArea.classList.remove('hidden');
      monthlyArea.classList.add('hidden');
    } else {
      monthlyArea.classList.remove('hidden');
      dailyArea.classList.add('hidden');
    }
  }

  // --- 4. Submit form (Insert Goal) ---
  async function handleFormSubmit(event) {
    event.preventDefault();

    saveGoalBtn.disabled = true;
    saveGoalBtn.innerHTML = "‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    const formData = new FormData(goalForm);
    const type = formData.get("goalType");

    const goalObject = {
      user_id: formData.get("user_id"),
      type,
      target_sales: parseInt(formData.get("target_sales")),
      date: type === "daily" ? formData.get("date") : null,
      month: type === "monthly" ? parseInt(formData.get("month")) : null
    };

    console.log("Insert -> ", goalObject);

    const { data, error } = await supabase
      .from("goals")
      .insert([goalObject])
      .select(`
        id,
        target_sales,
        type,
        date,
        month,
        userDash ( userName )
      `);

    if (error) {
      console.error("Insert error:", error);
      formMessage.innerHTML = `<span class="text-red-500">‚ùå ${error.message}</span>`;
    } else {
      const result = data[0];

      displayUser.textContent = result.userDash.userName;
      displayType.textContent = (result.type === "daily") ? "‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô" : "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
      displaySales.textContent = "‡∏ø" + result.target_sales.toLocaleString();
      displayPeriod.textContent = (result.type === "daily") ? result.date : result.month;
      displayID.textContent = result.id;

      goalDataDisplay.classList.remove("hidden");
      formMessage.innerHTML = `<span class="text-green-600">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>`;
      goalForm.reset();
    }

    saveGoalBtn.disabled = false;
    saveGoalBtn.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢";
  }

  // --- Event Listeners ---
  document.addEventListener("DOMContentLoaded", () => {
    loadUsers();
    toggleGoalArea();
    goalTypeRadios.forEach(radio => radio.addEventListener("change", toggleGoalArea));
    goalForm.addEventListener("submit", handleFormSubmit);
  });
</script>


</body>
</html>