<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">

  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6">
    <a href="index.html" class="inline-flex items-center text-blue-500 hover:text-blue-700 mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
        <span>Back to Dashboard</span>
    </a>
    
    <div class="flex flex-col items-center justify-center text-center mb-6">
      <img id="userImage" src="https://via.placeholder.com/100" class="w-20 h-20 rounded-full mb-2 border-2 border-blue-400 shadow-md">
      <h1 class="text-3xl font-bold" id="userNameHeader">Sales List</h1>
      <p class="text-gray-500" id="timeRangeInfo"></p>
    </div>

    <div class="flex justify-center space-x-2 mb-6">
        <button id="filterDay" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">Day</button>
        <button id="filterWeek" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">Week</button>
        <button id="filterMonth" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">Month</button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 shadow rounded-lg">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales (฿)</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          </tr>
        </thead>
        <tbody id="salesTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
      </table>
    </div>
  </div>

<script>
  const SUPABASE_URL = 'https://ocmskhrypxeljgncyffp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jbXNraHJ5cHhlbGpnbmN5ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDcyMzIsImV4cCI6MjA3MzQ4MzIzMn0.clWbGRV1MrUHnWPyTEc66fnjbD8mLqo6fF1V6qiOJa4';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let currentUserId; // ✅ แก้ไขจาก userName เป็น userId
  let currentTimeRange;

  function getUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    currentUserId = urlParams.get('userId'); // ✅ รับค่า userId จาก URL
    currentTimeRange = urlParams.get('timeRange') || 'day';
  }

  function getTimeRange(filter) {
    const now = new Date();
    let startDate = new Date();
    let endDate = new Date();

    if (filter === 'day') {
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    } else if (filter === 'week') {
        startDate.setDate(now.getDate() - now.getDay());
        endDate.setDate(startDate.getDate() + 6);
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    } else if (filter === 'month') {
        startDate.setDate(1);
        endDate.setMonth(now.getMonth() + 1, 0);
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    }
    return {
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString()
    };
  }

  async function fetchSalesData() {
    if (!currentUserId) {
        console.error("User ID is missing.");
        return;
    }
    
    const { startDate, endDate } = getTimeRange(currentTimeRange);
    
    // ✅ ดึงชื่อผู้ใช้และรูปภาพ
    const { data: userData, error: userError } = await supabase
      .from('userDash')
      .select('userName, img')
      .eq('id', currentUserId)
      .single();

    if (userError) {
      console.error('Error fetching user data:', userError.message);
      document.getElementById('userNameHeader').innerText = 'Sales List';
      document.getElementById('userImage').src = 'https://via.placeholder.com/100';
    } else {
      document.getElementById('userNameHeader').innerText = `${userData.userName}'s Sales List`;
      document.getElementById('userImage').src = userData.img || 'https://via.placeholder.com/100';
    }

    const { data: salesData, error } = await supabase
      .from('sales')
      .select('id, created_at, product_name, sales, units')
      .eq('user_id', currentUserId)
      .gte('created_at', startDate)
      .lte('created_at', endDate)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error fetching sales data:', error.message);
      return;
    }

    renderSalesTable(salesData);
  }

  function renderSalesTable(salesData) {
    const tableBody = document.getElementById('salesTableBody');
    tableBody.innerHTML = '';
    
    if (salesData.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No sales data found for this period.</td></tr>';
      return;
    }
    
    salesData.forEach(sale => {
      const row = `
        <tr class="hover:bg-gray-100">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(sale.created_at).toLocaleDateString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.product_name || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">฿${sale.sales.toLocaleString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.units}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            <button onclick="deleteSale(${sale.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
              Delete
            </button>
          </td>
        </tr>
      `;
      tableBody.insertAdjacentHTML('beforeend', row);
    });
  }

  function updateUI() {
    document.getElementById('timeRangeInfo').innerText = `Displaying data for ${currentTimeRange}`;
    
    document.querySelectorAll('button').forEach(btn => {
      if (btn.id === `filter${currentTimeRange.charAt(0).toUpperCase() + currentTimeRange.slice(1)}`) {
        btn.className = 'px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors';
      } else {
        btn.className = 'px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors';
      }
    });
  }

  async function deleteSale(id) {
    const password = prompt("Enter admin password to confirm delete:");
    if (!password) return;

    if (password !== "admin1234") { 
      alert("❌ Wrong password");
      return;
    }

    const { error } = await supabase
      .from('sales')
      .delete()
      .eq('id', id);

    if (error) {
      console.error(error);
      alert("Error deleting sale");
    } else {
      alert("✅ Sale deleted");
      fetchSalesData();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    getUrlParams();
    updateUI();
    fetchSalesData();
  });

  document.getElementById('filterDay').addEventListener('click', () => {
    currentTimeRange = 'day';
    fetchSalesData();
    updateUI();
  });

  document.getElementById('filterWeek').addEventListener('click', () => {
    currentTimeRange = 'week';
    fetchSalesData();
    updateUI();
  });

  document.getElementById('filterMonth').addEventListener('click', () => {
    currentTimeRange = 'month';
    fetchSalesData();
    updateUI();
  });
</script>

</body>
</html>